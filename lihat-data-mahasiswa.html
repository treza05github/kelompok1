<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Mahasiswa</title>
  <link rel="stylesheet" href="lihat-data.css">
</head>
<body>
  <h1>Data Nilai Mahasiswa</h1>

  <table>
    <thead>
      <tr>
        <th>Nama Lengkap</th>
        <th>NIM</th>
        <th>Mata Kuliah</th>
        <th>Nilai</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody id="tabelData"></tbody>
  </table>

  <p><a href="index.html">← Kembali ke halaman beranda</a></p>
  <p><a href="input-nilai.html">← Kembali ke Input Data</a></p>

  <script type="module">
    import { db } from "./firebase-config.js";
    import {
      collection,
      getDocs,
      updateDoc,
      deleteDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const tabel = document.getElementById("tabelData");
    const nilaiRef = collection(db, "nilaiMahasiswa");

    async function loadData() {
      tabel.innerHTML = "";
      const snapshot = await getDocs(nilaiRef);

      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const row = document.createElement("tr");

        row.innerHTML = `
          <td>${data.nama}</td>
          <td>${data.nim}</td>
          <td>${data.matkul}</td>
          <td>${data.nilai}</td>
          <td>
            <button class="edit">Edit</button>
            <button class="hapus">Hapus</button>
          </td>
        `;

        // Tombol Hapus
        row.querySelector(".hapus").addEventListener("click", async () => {
          if (confirm("Yakin ingin menghapus data ini?")) {
            await deleteDoc(doc(db, "nilaiMahasiswa", docSnap.id));
            alert("Data berhasil dihapus!");
            loadData();
          }
        });

        // Tombol Edit
        row.querySelector(".edit").addEventListener("click", () => {
          const cells = row.querySelectorAll("td");
          const namaCell = cells[0];
          const nimCell = cells[1];
          const matkulCell = cells[2];
          const nilaiCell = cells[3];
          const aksiCell = cells[4];

          // Ubah menjadi input
          namaCell.innerHTML = `<input type="text" value="${data.nama}" />`;
          nimCell.innerHTML = `<input type="text" value="${data.nim}" />`;
          matkulCell.innerHTML = `
          <select>
            <option value="Rekayasa Perangkat Lunak" ${data.matkul === "Rekayasa Perangkat Lunak" ? "selected" : ""}>Rekayasa Perangkat Lunak</option>
            <option value="Multimedia" ${data.matkul === "Multimedia" ? "selected" : ""}>Multimedia</option>
            <option value="Sistem Operasi" ${data.matkul === "Sistem Operasi" ? "selected" : ""}>Sistem Operasi</option>
            <option value="Basis Data" ${data.matkul === "Basis Data" ? "selected" : ""}>Basis Data</option>
            <option value="Pemrograman" ${data.matkul === "Pemrograman" ? "selected" : ""}>Pemrograman</option>
          </select>
          `;
          nilaiCell.innerHTML = `<input type="text" value="${data.nilai}" />`;

          aksiCell.innerHTML = `
            <button class="simpan">Simpan</button>
            <button class="batal">Batal</button>
          `;

          // Tombol Simpan
          aksiCell.querySelector(".simpan").addEventListener("click", async () => {
            const namaBaru = namaCell.querySelector("input").value;
            const nimBaru = nimCell.querySelector("input").value;
            const matkulBaru = matkulCell.querySelector("select").value;
            const nilaiBaru = nilaiCell.querySelector("input").value;

            if (namaBaru && nimBaru && matkulBaru && nilaiBaru) {
              await updateDoc(doc(db, "nilaiMahasiswa", docSnap.id), {
                nama: namaBaru,
                nim: nimBaru,
                matkul: matkulBaru,
                nilai: nilaiBaru
              });
              alert("Data berhasil diperbarui!");
              loadData();
            } else {
              alert("Semua field harus diisi!");
            }
          });

          // Tombol Batal
          aksiCell.querySelector(".batal").addEventListener("click", () => {
            loadData(); // Kembalikan ke tampilan normal
          });
        });

        tabel.appendChild(row);
      });
    }

    loadData();
  </script>
</body>
</html>
